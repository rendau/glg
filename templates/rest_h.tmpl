package rest

import (
	"net/http"
	"strconv"

	"github.com/gorilla/mux"
	"{{ .Pr.Uri }}/{{ .Pr.EntitiesDirPath.Rel }}"
)

// swagger:parameters hUsrGet hUsrUpdate hUsrDelete
type docUsrPathParIdSt struct {
	// in: path
	Id int64 `json:"id"`
}

// swagger:parameters hUsrCreate hUsrUpdate
type docUsrBodyParObjSt struct {
	// in: body
	Body entities.UsrCUSt
}

// swagger:route GET /usrs usrs hUsrList
// Allowed to: `UsrTypeAdmin`
// Security:
//   token:
// Responses:
//   200: usrListRep
//   400: errRep
func (a *St) h{{ .EName.Camel }}List(w http.ResponseWriter, r *http.Request) {
	// swagger:parameters hUsrList
	type docReqSt struct {
		// in:query
		entities.PaginationParams

		// in:query
		TypeId int `json:"type_id"`

		// in:query
		OnlyCount int `json:"only_count"`

		// in:query
		Search int `json:"search"`
	}

	// swagger:response usrListRep
	type docRepSt struct {
		// in:body
		Body struct {
			DocPaginatedListRepSt
			Results []*entities.UsrListSt `json:"results"`
		}
	}

	{{- if .Ent.ListParsSt }}
		{{ if not (len .Ctx4List.parsFields) }}// {{ end }}qPars := r.URL.Query()

		pars := &entities.{{ .EName.Camel }}ListParsSt{
		{{- range $field := .Ctx4List.parsFields }}
			{{- if getQueryParParser $field }}
				{{ $field.Name.Origin }}: a.{{ getQueryParParser $field }}(qPars, "{{ $field.Name.Snake }}"),
			{{- end }}
		{{- end }}
		}

		{{- if .Ctx4List.hasPagination }}

			offset, limit, page := a.uExtractPaginationPars(qPars)
			pars.Offset = offset
			pars.Limit = limit

			paginated := pars.Limit > 0

			result, tCount, err := a.ucs.{{ .EName.Camel }}List(a.uGetRequestContext(r), pars)
			if a.uHandleError(err, r, w) {
				return
			}

			if paginated {
				a.uRespondJSON(w, &PaginatedListRepSt{
					Page:       page,
					PageSize:   limit,
					TotalCount: tCount,
					Results:    result,
				})
			} else {
				a.uRespondJSON(w, result)
			}
		{{- else }}

			result, err := a.ucs.{{ .EName.Camel }}List(a.uGetRequestContext(r), pars)
			if a.uHandleError(err, r, w) {
				return
			}

			a.uRespondJSON(w, result)
		{{- end }}
	{{- else }}
		result, err := a.ucs.{{ .EName.Camel }}List(a.uGetRequestContext(r))
		if a.uHandleError(err, r, w) {
			return
		}

		a.uRespondJSON(w, result)
	{{- end }}
}

// swagger:route POST /usrs usrs hUsrCreate
// Allowed to: `UsrTypeAdmin`
// Security:
//   token:
// Responses:
//   200: usrCreateRep
//   400: errRep
func (a *St) h{{ .EName.Camel }}Create(w http.ResponseWriter, r *http.Request) {
	// swagger:response usrCreateRep
	type docRepSt struct {
		// in:body
		Body struct {
			Id int64 `json:"id"`
		}
	}

	reqObj := &entities.{{ .EName.Camel }}CUSt{}
	if !a.uParseRequestJSON(w, r, reqObj) {
		return
	}

	{{ if .Ent.IdField }}result, {{ end }}err := a.ucs.{{ .EName.Camel }}Create(a.uGetRequestContext(r), reqObj)
	if a.uHandleError(err, r, w) {
		return
	}

	{{ if .Ent.IdField -}}
		a.uRespondJSON(w, map[string]{{ .Ent.IdField.Type -}}{"{{ .Ent.IdField.JsonName -}}": result})
	{{- else }}
		w.WriteHeader(200)
	{{- end }}
}

{{ if or .Ent.GetParsSt .Ent.IdField }}
// swagger:route GET /usrs/{id} usrs hUsrGet
// Security:
//   token:
// Responses:
//   200: usrRep
//   400: errRep
func (a *St) h{{ .EName.Camel }}Get(w http.ResponseWriter, r *http.Request) {
	// swagger:response usrRep
	type docRepSt struct {
		// in:body
		Body *entities.UsrSt
	}

	{{- if .Ent.GetParsSt }}
		{{- if .Ent.GetParsSt.IdField }}
			args := mux.Vars(r)
			{{- if .Ent.IdField.IsTypeInt }}
				{{ .Ent.IdField.Name.LCamel }}, _ := strconv.ParseInt(args["{{ .Ent.IdField.JsonName }}"], 10, 64)
			{{- else }}
				{{ .Ent.IdField.Name.LCamel }} := args["{{ .Ent.IdField.JsonName }}"]
			{{- end }}

		{{ end -}}
		qPars := r.URL.Query()

		pars := &entities.{{ .EName.Camel }}GetParsSt{
		{{- if .Ent.GetParsSt.IdField }}
			{{ .Ent.GetParsSt.IdField.Name.Origin }}: {{ if .Ent.GetParsSt.IdField.IsTypePointer }}&{{ end }}{{ .Ent.IdField.Name.LCamel }},
		{{- end }}
		{{- range $field := .Ent.GetParsSt.Fields }}
			{{- if not $field.IsId }}
				{{- if getQueryParParser $field }}
					{{ $field.Name.Origin }}: a.{{ getQueryParParser $field }}(qPars, "{{ $field.Name.Snake }}"),
				{{- end }}
			{{- end }}
		{{- end }}
		}

		result, err := a.ucs.{{ .EName.Camel }}Get(a.uGetRequestContext(r), pars)
		if a.uHandleError(err, r, w) {
			return
		}
	{{- else }}
		args := mux.Vars(r)
		{{- if .Ent.IdField.IsTypeInt }}
			{{ .Ent.IdField.Name.LCamel }}, _ := strconv.ParseInt(args["{{ .Ent.IdField.JsonName }}"], 10, 64)
		{{- else }}
			{{ .Ent.IdField.Name.LCamel }} := args["{{ .Ent.IdField.JsonName }}"]
		{{- end }}

		result, err := a.ucs.{{ .EName.Camel }}Get(a.uGetRequestContext(r), {{ .Ent.IdField.Name.LCamel }})
		if a.uHandleError(err, r, w) {
			return
		}
	{{- end }}

	a.uRespondJSON(w, result)
}
{{ end }}

{{ if .Ent.IdField }}
// swagger:route PUT /usrs/{id} usrs hUsrUpdate
// Allowed to: `UsrTypeAdmin`
// Security:
//   token:
// Responses:
//   200:
//   400: errRep
func (a *St) h{{ .EName.Camel }}Update(w http.ResponseWriter, r *http.Request) {
	args := mux.Vars(r)
	{{- if .Ent.IdField.IsTypeInt }}
		{{ .Ent.IdField.Name.LCamel }}, _ := strconv.ParseInt(args["{{ .Ent.IdField.JsonName }}"], 10, 64)
	{{- else }}
		{{ .Ent.IdField.Name.LCamel }} := args["{{ .Ent.IdField.JsonName }}"]
	{{- end }}

	reqObj := &entities.{{ .EName.Camel }}CUSt{}
	if !a.uParseRequestJSON(w, r, reqObj) {
		return
	}

	err := a.ucs.{{ .EName.Camel }}Update(a.uGetRequestContext(r), {{ .Ent.IdField.Name.LCamel }}, reqObj)
	if a.uHandleError(err, r, w) {
		return
	}

	w.WriteHeader(200)
}
{{ end }}

{{ if .Ent.IdField }}
// swagger:route DELETE /usrs/{id} usrs hUsrDelete
// Allowed to: `UsrTypeAdmin`
// Security:
//   token:
// Responses:
//   200:
//   400: errRep
func (a *St) h{{ .EName.Camel }}Delete(w http.ResponseWriter, r *http.Request) {
	args := mux.Vars(r)
	{{- if .Ent.IdField.IsTypeInt }}
		{{ .Ent.IdField.Name.LCamel }}, _ := strconv.ParseInt(args["{{ .Ent.IdField.JsonName }}"], 10, 64)
	{{- else }}
		{{ .Ent.IdField.Name.LCamel }} := args["{{ .Ent.IdField.JsonName }}"]
	{{- end }}

	err := a.ucs.{{ .EName.Camel }}Delete(a.uGetRequestContext(r), {{ .Ent.IdField.Name.LCamel }})
	if a.uHandleError(err, r, w) {
		return
	}

	w.WriteHeader(200)
}
{{ end }}
